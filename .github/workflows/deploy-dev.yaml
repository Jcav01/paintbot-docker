name: Deploy to Development

on:
  push:
    branches:
      - develop
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'Development'
        type: choice
        options:
          - Development
          - Staging
permissions:
  id-token: write
  contents: read

env:
  PROJECT_ID: paintbot
  GKE_CLUSTER: paintbot-cluster
  GKE_ZONE: northamerica-northeast1
  REGISTRY: northamerica-northeast1-docker.pkg.dev
  REGISTRY_PROJECT: paintbot
  REGISTRY_REPO: paintbot

concurrency:
  group: ${{ github.workflow }}-Development
  cancel-in-progress: true

jobs:
  build-images:
    name: Build and Push Service Images
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - service: database
            build-args: ''
          - service: discord
            build-args: ''
          - service: twitch
            build-args: NODE_ENV=production
          - service: youtube
            build-args: ''

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - id: auth
        name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          project_id: '${{ vars.GKE_PROJECT_ID }}'
          workload_identity_provider: '${{ secrets.WORKLOAD_IDENTITY_PROVIDER }}'

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Authenticate docker to Artifact Registry
        run: |
          gcloud --quiet components install docker-credential-gcloud || true
          gcloud auth configure-docker $REGISTRY --quiet

      - name: Set up Buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver: docker-container

      - name: Show active GCP account and access token info
        run: |
          gcloud auth list
          gcloud config list
          gcloud auth print-identity-token --quiet
          gcloud auth print-access-token --quiet | head -c 20; echo '...'

      - name: Check caller permissions for Artifact Registry
        run: |
          echo "Who am I?"
          gcloud auth list
          echo "Testing permissions on Artifact Registry repo..."
          gcloud artifacts repositories get-iam-policy paintbot \
            --location=northamerica-northeast1 \
            --project=paintbot \
            --format=json

      - name: Build and push ${{ matrix.service }} image
        uses: docker/build-push-action@v6
        with:
          context: ${{ matrix.service }}
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.REGISTRY_PROJECT }}/${{ env.REGISTRY_REPO }}/${{ matrix.service }}:${{ github.sha }}
            ${{ env.REGISTRY }}/${{ env.REGISTRY_PROJECT }}/${{ env.REGISTRY_REPO }}/${{ matrix.service }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: ${{ matrix.build-args || '' }}
          provenance: false

  deploy-dev:
    name: Deploy to Development Environment
    needs: build-images
    runs-on: ubuntu-latest
    environment: Development

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - id: 'auth'
        name: 'Authenticate to Google Cloud'
        uses: 'google-github-actions/auth@v2'
        with:
          project_id: '${{ vars.GKE_PROJECT_ID }}'
          workload_identity_provider: '${{ secrets.WORKLOAD_IDENTITY_PROVIDER }}'

      - name: 'Set up Cloud SDK'
        uses: 'google-github-actions/setup-gcloud@v2'

      - name: 'Install auth plugin'
        run: 'gcloud components install gke-gcloud-auth-plugin --quiet'

      - name: Configure Docker to use gcloud as a credential helper
        run: gcloud auth configure-docker $REGISTRY --quiet

      - name: Get GKE credentials
        run: gcloud container clusters get-credentials "$GKE_CLUSTER" --zone "$GKE_ZONE"

      - name: Ensure development namespace exists
        run: |-
          kubectl get ns development || kubectl create ns development

      - name: Sync Cloudflared tunnel credentials
        shell: bash
        run: |
          mkdir -p "$RUNNER_TEMP/cloudflared"
          printf '%s' "${{ secrets.CLOUDFLARED_CREDENTIALS_B64 }}" | base64 --decode > "$RUNNER_TEMP/cloudflared/credentials.json"
          kubectl create secret generic cloudflared-credentials \
            --from-file=credentials.json="$RUNNER_TEMP/cloudflared/credentials.json" \
            --namespace development \
            --dry-run=client -o yaml | kubectl apply -f -

      # Verify secrets exist before deployment
      - name: Verify Kubernetes Secrets Exist
        run: |-
          echo "Checking for required secrets..."
          kubectl get secret twitch-secrets -n development || (echo "❌ twitch-secrets not found" && exit 1)
          kubectl get secret discord-secrets -n development || (echo "❌ discord-secrets not found" && exit 1)
          kubectl get secret database-secrets -n development || (echo "❌ database-secrets not found" && exit 1)
          kubectl get secret youtube-secrets -n development || (echo "❌ youtube-secrets not found" && exit 1)
          kubectl get secret paintbot-service-account -n development || (echo "❌ paintbot-service-account not found" && exit 1)
          kubectl get secret cloudflared-credentials -n development || (echo "❌ cloudflared-credentials not found" && exit 1)
          echo "✅ All required secrets found"

      # Apply config and Deploy via Kustomize overlay
      - name: Deploy to GKE
        run: |-
          kubectl apply -k k8s/overlays/development

      - name: Verify deployment
        run: |-
          # Wait for deployments to be ready
          kubectl wait --for=condition=available --timeout=300s deployment/database deployment/discord deployment/twitch deployment/youtube -n development

          # Show deployment status
          kubectl get deployments -n development
          kubectl get pods -n development
          kubectl get services -o wide -n development

      # Update deployment with new image tags
      - name: Update deployment images
        run: |-
          for deployment in database discord twitch youtube; do
            kubectl set image deployment/$deployment $deployment="$REGISTRY/$REGISTRY_PROJECT/$REGISTRY_REPO/$deployment:$GITHUB_SHA" -n development
            kubectl rollout status deployment/$deployment -n development
          done
