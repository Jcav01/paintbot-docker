name: Production Deployment

on:
  push:
    branches:
      - main
permissions:
  id-token: write
  contents: read

env:
  PROJECT_ID: paintbot
  GKE_CLUSTER: paintbot-cluster
  GKE_ZONE: northamerica-northeast1
  REGISTRY: northamerica-northeast1-docker.pkg.dev
  REGISTRY_PROJECT: paintbot
  REGISTRY_REPO: paintbot

concurrency:
  group: ${{ github.workflow }}-Production
  cancel-in-progress: true

jobs:
  setup-build-publish-deploy:
    name: Setup, Build, Publish, and Deploy
    runs-on: ubuntu-latest
    environment: Production

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - id: auth
        name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          project_id: ${{ vars.GKE_PROJECT_ID }}
          workload_identity_provider: ${{ secrets.WORKLOAD_IDENTITY_PROVIDER }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Install auth plugin
        run: gcloud components install gke-gcloud-auth-plugin --quiet

      - name: Configure Docker to use gcloud as a credential helper
        run: gcloud auth configure-docker $REGISTRY --quiet

      - name: Get GKE credentials
        run: gcloud container clusters get-credentials "$GKE_CLUSTER" --zone "$GKE_ZONE"

      - name: Ensure production namespace exists
        run: kubectl get ns production || kubectl create ns production

      # Build and push Docker images
      - name: Build and Push Database Image
        run: |
          cd database
          docker build -t "$REGISTRY/$REGISTRY_PROJECT/$REGISTRY_REPO/database:$GITHUB_SHA" .
          docker push "$REGISTRY/$REGISTRY_PROJECT/$REGISTRY_REPO/database:$GITHUB_SHA"
          docker tag "$REGISTRY/$REGISTRY_PROJECT/$REGISTRY_REPO/database:$GITHUB_SHA" "$REGISTRY/$REGISTRY_PROJECT/$REGISTRY_REPO/database:latest"
          docker push "$REGISTRY/$REGISTRY_PROJECT/$REGISTRY_REPO/database:latest"

      - name: Build and Push Discord Image
        run: |
          cd discord
          docker build -t "$REGISTRY/$REGISTRY_PROJECT/$REGISTRY_REPO/discord:$GITHUB_SHA" .
          docker push "$REGISTRY/$REGISTRY_PROJECT/$REGISTRY_REPO/discord:$GITHUB_SHA"
          docker tag "$REGISTRY/$REGISTRY_PROJECT/$REGISTRY_REPO/discord:$GITHUB_SHA" "$REGISTRY/$REGISTRY_PROJECT/$REGISTRY_REPO/discord:latest"
          docker push "$REGISTRY/$REGISTRY_PROJECT/$REGISTRY_REPO/discord:latest"

      - name: Build and Push Twitch Image
        run: |
          cd twitch
          docker build --build-arg NODE_ENV=production -t "$REGISTRY/$REGISTRY_PROJECT/$REGISTRY_REPO/twitch:$GITHUB_SHA" .
          docker push "$REGISTRY/$REGISTRY_PROJECT/$REGISTRY_REPO/twitch:$GITHUB_SHA"
          docker tag "$REGISTRY/$REGISTRY_PROJECT/$REGISTRY_REPO/twitch:$GITHUB_SHA" "$REGISTRY/$REGISTRY_PROJECT/$REGISTRY_REPO/twitch:latest"
          docker push "$REGISTRY/$REGISTRY_PROJECT/$REGISTRY_REPO/twitch:latest"

      - name: Build and Push YouTube Image
        run: |
          cd youtube
          docker build -t "$REGISTRY/$REGISTRY_PROJECT/$REGISTRY_REPO/youtube:$GITHUB_SHA" .
          docker push "$REGISTRY/$REGISTRY_PROJECT/$REGISTRY_REPO/youtube:$GITHUB_SHA"
          docker tag "$REGISTRY/$REGISTRY_PROJECT/$REGISTRY_REPO/youtube:$GITHUB_SHA" "$REGISTRY/$REGISTRY_PROJECT/$REGISTRY_REPO/youtube:latest"
          docker push "$REGISTRY/$REGISTRY_PROJECT/$REGISTRY_REPO/youtube:latest"

      - name: Verify Kubernetes Secrets Exist (production)
        run: |
          echo "Checking for required secrets..."
          kubectl get secret twitch-secrets -n production || (echo "❌ twitch-secrets not found" && exit 1)
          kubectl get secret discord-secrets -n production || (echo "❌ discord-secrets not found" && exit 1)
          kubectl get secret database-secrets -n production || (echo "❌ database-secrets not found" && exit 1)
          kubectl get secret youtube-secrets -n production || (echo "❌ youtube-secrets not found" && exit 1)
          kubectl get secret paintbot-service-account -n production || (echo "❌ paintbot-service-account not found" && exit 1)
          echo "✅ All required secrets found"

      - name: Deploy to GKE
        run: |
          kubectl apply -f k8s/config/production-configmap.yaml
          kubectl apply -f k8s/database-deployment.yaml -n production
          kubectl apply -f k8s/database-pdb.yaml -n production
          kubectl apply -f k8s/discord-deployment.yaml -n production
          kubectl apply -f k8s/twitch-deployment.yaml -n production
          kubectl apply -f k8s/youtube-deployment.yaml -n production

      - name: Adjust production settings (replicas)
        run: |
          # HA for database in production
          kubectl scale deployment/database --replicas=2 -n production

      - name: Verify deployment
        run: |-
          # Wait for deployments to be ready
          kubectl wait --for=condition=available --timeout=300s deployment/database -n production
          kubectl wait --for=condition=available --timeout=300s deployment/discord -n production
          kubectl wait --for=condition=available --timeout=300s deployment/twitch -n production
          kubectl wait --for=condition=available --timeout=300s deployment/youtube -n production

          # Show deployment status
          kubectl get deployments -n production
          kubectl get pods -n production
          kubectl get services -o wide -n production

      # Update deployment with new image tags
      - name: Update Database deployment image
        run: |-
          kubectl set image deployment/database database="$REGISTRY/$REGISTRY_PROJECT/$REGISTRY_REPO/database:$GITHUB_SHA" -n production
          kubectl rollout status deployment/database -n production

      - name: Update Discord deployment image
        run: |-
          kubectl set image deployment/discord discord="$REGISTRY/$REGISTRY_PROJECT/$REGISTRY_REPO/discord:$GITHUB_SHA" -n production
          kubectl rollout status deployment/discord -n production

      - name: Update Twitch deployment image
        run: |-
          kubectl set image deployment/twitch twitch="$REGISTRY/$REGISTRY_PROJECT/$REGISTRY_REPO/twitch:$GITHUB_SHA" -n production
          kubectl rollout status deployment/twitch -n production

      - name: Update YouTube deployment image
        run: |-
          kubectl set image deployment/youtube youtube="$REGISTRY/$REGISTRY_PROJECT/$REGISTRY_REPO/youtube:$GITHUB_SHA" -n production
          kubectl rollout status deployment/youtube -n production
