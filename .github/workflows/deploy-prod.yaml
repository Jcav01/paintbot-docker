name: Production Deployment

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'Production'
        type: choice
        options:
          - Production
permissions:
  id-token: write
  contents: read

env:
  PROJECT_ID: paintbot
  GKE_CLUSTER: paintbot-cluster
  GKE_ZONE: northamerica-northeast1
  REGISTRY: northamerica-northeast1-docker.pkg.dev
  REGISTRY_PROJECT: paintbot
  REGISTRY_REPO: paintbot

concurrency:
  group: ${{ github.workflow }}-Production
  cancel-in-progress: true

jobs:
  build-images:
    name: Build and Push Service Images
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - service: database
            build-args: ''
          - service: discord
            build-args: ''
          - service: twitch
            build-args: NODE_ENV=production
          - service: youtube
            build-args: ''

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - id: auth
        name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          project_id: '${{ vars.GKE_PROJECT_ID }}'
          workload_identity_provider: '${{ secrets.WORKLOAD_IDENTITY_PROVIDER }}'
          service_account: '${{ secrets.GKE_SA_EMAIL }}'
          token_format: 'access_token'

      - name: Log in to Artifact Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: oauth2accesstoken
          password: ${{ steps.auth.outputs.access_token }}

      - name: Set up Buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver: docker-container

      - name: Build and push ${{ matrix.service }} image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ${{ matrix.service }}/Dockerfile
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.REGISTRY_PROJECT }}/${{ env.REGISTRY_REPO }}/${{ matrix.service }}:${{ github.sha }}
            ${{ env.REGISTRY }}/${{ env.REGISTRY_PROJECT }}/${{ env.REGISTRY_REPO }}/${{ matrix.service }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: ${{ matrix.build-args || '' }}
          provenance: false

  deploy-prod:
    name: Deploy to Production Environment
    needs: build-images
    runs-on: ubuntu-latest
    environment: Production

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - id: 'auth'
        name: 'Authenticate to Google Cloud'
        uses: 'google-github-actions/auth@v2'
        with:
          project_id: '${{ vars.GKE_PROJECT_ID }}'
          workload_identity_provider: '${{ secrets.WORKLOAD_IDENTITY_PROVIDER }}'

      - name: 'Set up Cloud SDK'
        uses: 'google-github-actions/setup-gcloud@v2'

      - name: 'Install auth plugin'
        run: 'gcloud components install gke-gcloud-auth-plugin --quiet'

      - name: Configure Docker to use gcloud as a credential helper
        run: gcloud auth configure-docker $REGISTRY --quiet

      - name: Get GKE credentials
        run: gcloud container clusters get-credentials "$GKE_CLUSTER" --zone "$GKE_ZONE"

      - name: Sync Cloudflared tunnel credentials
        shell: bash
        run: |
          mkdir -p "$RUNNER_TEMP/cloudflared"
          printf '%s' "${{ secrets.CLOUDFLARED_CREDENTIALS_B64 }}" | base64 --decode > "$RUNNER_TEMP/cloudflared/credentials.json"
          kubectl create secret generic cloudflared-credentials \
            --from-file=credentials.json="$RUNNER_TEMP/cloudflared/credentials.json" \
            --namespace default \
            --dry-run=client -o yaml | kubectl apply -f -

      # Verify secrets exist before deployment
      - name: Verify Kubernetes Secrets Exist
        run: |-
          echo "Checking for required secrets..."
          kubectl get secret twitch-secrets -n default || (echo "❌ twitch-secrets not found" && exit 1)
          kubectl get secret discord-secrets -n default || (echo "❌ discord-secrets not found" && exit 1)
          kubectl get secret database-secrets -n default || (echo "❌ database-secrets not found" && exit 1)
          kubectl get secret youtube-secrets -n default || (echo "❌ youtube-secrets not found" && exit 1)
          kubectl get secret paintbot-service-account -n default || (echo "❌ paintbot-service-account not found" && exit 1)
          kubectl get secret cloudflared-credentials -n default || (echo "❌ cloudflared-credentials not found" && exit 1)
          echo "✅ All required secrets found"

      # Apply config and Deploy via Kustomize overlay
      - name: Deploy to GKE
        run: |-
          kubectl apply -k k8s/overlays/production

      - name: Verify deployment
        run: |-
          # Wait for deployments to be ready
          kubectl wait --for=condition=available --timeout=300s deployment/database -n default
          kubectl wait --for=condition=available --timeout=300s deployment/discord -n default
          kubectl wait --for=condition=available --timeout=300s deployment/twitch -n default
          kubectl wait --for=condition=available --timeout=300s deployment/youtube -n default

          # Show deployment status
          kubectl get deployments -n default
          kubectl get pods -n default
          kubectl get services -o wide -n default

      # Update deployment with new image tags
      - name: Update deployment images
        run: |-
          for deployment in database discord twitch youtube; do
            kubectl set image deployment/$deployment $deployment="$REGISTRY/$REGISTRY_PROJECT/$REGISTRY_REPO/$deployment:$GITHUB_SHA" -n default
            kubectl rollout status deployment/$deployment -n default
          done
